{% extends "base.html" %}
{% block title %}Transcript - {{ transcript.channel_name }}{% endblock %}

{% block content %}
<style>
    .transcript-header { border-bottom: 1px solid var(--bg-lighter); padding-bottom: 15px; margin-bottom: 30px; }
    .transcript-header h1 { margin: 0; font-size: 24px; color: #fff; }
    .transcript-header p { margin: 5px 0 0; color: var(--text-dark); }
    .message-group { display: flex; margin-bottom: 25px; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; flex-shrink: 0; }
    .message-content { flex-grow: 1; }
    .author-info { display: flex; align-items: center; margin-bottom: 5px; }
    .author-name { font-weight: 600; color: #fff; margin-right: 10px; }
    .timestamp { font-size: 12px; color: var(--text-dark); }
    .message-text { line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
    .message-text img { max-width: 100%; border-radius: 6px; margin-top: 8px; }
    .reply-form { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--bg-lighter); }
    .reply-form textarea { width: 100%; min-height: 100px; padding: 12px; border: 1px solid var(--bg-lighter); border-radius: 6px; background-color: var(--bg-dark); color: var(--text); resize: vertical; font-family: 'Inter', sans-serif; font-size: 14px; }
    .reply-form .button-group { margin-top: 10px; display: flex; justify-content: center; gap: 10px; }
    .reply-form button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: opacity 0.2s; }
    .reply-form .send-btn { background-color: var(--primary); color: var(--bg-dark); }
    .reply-form .close-btn { background-color: var(--red); color: var(--bg-dark); }
    .reply-form button:hover { opacity: 0.8; }
</style>

<div class="transcript-header">
    <h1>#{{ transcript.channel_name }}</h1>
    <p>
        Serveur : {{ transcript.guild_id }} | {{ transcript.messages | length }} messages
    </p>
</div>

{% for message in transcript.messages %}
<div class="message-group">
    <img src="{{ message.author_avatar }}" alt="Avatar" class="avatar">
    <div class="message-content">
        <div class="author-info">
            <span class="author-name">{{ message.author_name }}</span>
            <span class="timestamp">{{ message.timestamp | replace('T', ' ') | slice(0, 19) }}</span>
        </div>
        {% if message.content %}
        <div class="message-text">{{ message.content }}</div>
        {% endif %}
        {% for attachment in message.attachments %}
        <div class="message-text">
            <a href="{{ attachment }}" target="_blank"><img src="{{ attachment }}" alt="Pièce jointe"></a>
        </div>
        {% endfor %}
    </div>
</div>
{% endfor %}

{% if is_channel_active and current_user.is_authenticated and (current_user.role == 'staff' or current_user.role == 'owner') %}
<div class="reply-form">
    <form action="{{ url_for('send_ticket_message', transcript_id=transcript_id) }}" method="POST">
        <textarea name="message" placeholder="Écrire une réponse dans le ticket..." required></textarea>
        <div class="button-group">
            <button type="submit" class="send-btn">Envoyer la réponse</button>
            <form action="{{ url_for('close_ticket_from_web', transcript_id=transcript_id) }}" method="POST" style="display: contents;">
                <button type="submit" class="close-btn">Fermer le ticket</button>
            </form>
        </div>
    </form>
</div>
{% endif %}

{% endblock %}